<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MiniJuegos</title>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f3f7ff;
    }

    header {
      background: #a8d8ff;
      padding: 15px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      color: #fff;
    }

    .menu {
      display: flex;
      justify-content: center;
      gap: 20px;
      background: #d9ecff;
      padding: 12px;
    }

    .menu button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      background: #94caff;
      color: white;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.2s;
    }

    .menu button:hover {
      background: #73b8ff;
    }

    section {
      display: none;
      padding: 20px;
      text-align: center;
    }

    section.active {
      display: block;
    }

    canvas {
      background: #222;
      border: 3px solid #5ab4ff;
      border-radius: 10px;
    }

    #game-over {
      margin-top: 15px;
      display: none;
    }

    #game-over button {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      background: #94caff;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    #game-over button:hover {
      background: #73b8ff;
    }

    .leaderboard {
      margin: 30px auto 0;
      max-width: 500px;
      border-collapse: collapse;
      width: 100%;
      background: #ffffff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .leaderboard th,
    .leaderboard td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5efff;
      text-align: left;
      font-size: 14px;
    }

    .leaderboard th {
      background: #d9ecff;
      font-weight: bold;
    }

    .leaderboard tr:last-child td {
      border-bottom: none;
    }

    .leaderboard img {
      border-radius: 50%;
      vertical-align: middle;
      margin-right: 6px;
    }
    /* Layout del snake en dos columnas */
.snake-layout {
  display: flex;
  justify-content: center;
  gap: 40px;
  align-items: flex-start;
  margin-top: 20px;
}

/* Columna izquierda */
.snake-left {
  text-align: center;
}

/* Columna derecha (tabla) */
.snake-right {
  width: 300px;
}

/* Tabla */
.leaderboard {
  width: 100%;
  background: #ffffff;
  border-radius: 10px;
  overflow: hidden;
  border-collapse: collapse;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.leaderboard th, .leaderboard td {
  padding: 8px 10px;
  border-bottom: 1px solid #e5efff;
  font-size: 14px;
  text-align: left;
}

.leaderboard th {
  background: #d9ecff;
}

/* Responsive para cel */
@media (max-width: 900px) {
  .snake-layout {
    flex-direction: column;
    align-items: center;
  }

  .snake-right {
    width: 90%;
  }
}

  </style>
</head>
<body>

<header> MiniJuegos</header>

<div class="menu">
  <button onclick="mostrar('snake')"> Gusanito</button>
  <!-- Aqu铆 luego puedes a帽adir m谩s botones para otros juegos -->
</div>

<!-- Minijuego del Gusanito -->
<section id="snake" class="active">

  <h2 style="text-align:center;"> Gusanito</h2>

  <div class="snake-layout">

    <!-- IZQUIERDA: Juego -->
    <div class="snake-left">
      <p>Puntuaci贸n: <span id="score">0</span></p>

      <canvas id="canvas" width="400" height="400"></canvas>

      <div id="game-over">
        <p>Perdiste, Fluttershy </p>
        <button onclick="reiniciarJuego()">Reiniciar juego</button>
      </div>
    </div>

    <!-- DERECHA: Tabla de puntos -->
    <div class="snake-right">
      <h3> Tabla de puntos</h3>

      <table class="leaderboard">
        <thead>
          <tr>
            <th>#</th>
            <th>Jugador</th>
            <th>Puntos</th>
          </tr>
        </thead>
        <tbody id="leaderboard-body">
          <!-- JS lo llena -->
        </tbody>
      </table>
    </div>

  </div>
</section>


<script>
function mostrar(id) {
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* Evitar scroll con flechas */
window.addEventListener("keydown", function(e){
  if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)){
    e.preventDefault();
  }
}, { passive: false });

/* --- Juego Snake --- */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let snake;
let dx;
let dy;
let food;
let score;
let gameLoop;

document.addEventListener("keydown", cambiarDireccion);

function iniciarJuego() {
  snake = [{x: 200, y: 200}];
  dx = 20;
  dy = 0;
  food = generarComida();
  score = 0;
  document.getElementById("score").textContent = score;
  document.getElementById("game-over").style.display = "none";

  if (gameLoop) clearInterval(gameLoop);
  gameLoop = setInterval(actualizar, 100);
}

function actualizar() {
  const cabeza = {x: snake[0].x + dx, y: snake[0].y + dy};

  if (cabeza.x < 0 || cabeza.y < 0 ||
      cabeza.x >= canvas.width || cabeza.y >= canvas.height ||
      colision(cabeza)) {
    finDelJuego();
    return;
  }

  snake.unshift(cabeza);

  if (cabeza.x === food.x && cabeza.y === food.y) {
    score++;
    document.getElementById("score").textContent = score;
    food = generarComida();
  } else {
    snake.pop();
  }

  dibujar();
}

function dibujar() {
  ctx.fillStyle = "#222";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "#4aff70";
  snake.forEach(parte => ctx.fillRect(parte.x, parte.y, 20, 20));

  ctx.fillStyle = "#ff4f4f";
  ctx.fillRect(food.x, food.y, 20, 20);
}

function generarComida() {
  return {
    x: Math.floor(Math.random() * 20) * 20,
    y: Math.floor(Math.random() * 20) * 20
  };
}

function cambiarDireccion(e) {
  if (e.key === "ArrowUp" && dy === 0) { dx = 0; dy = -20; }
  if (e.key === "ArrowDown" && dy === 0) { dx = 0; dy = 20; }
  if (e.key === "ArrowLeft" && dx === 0) { dx = -20; dy = 0; }
  if (e.key === "ArrowRight" && dx === 0) { dx = 20; dy = 0; }
}

function colision(c) {
  for (let i = 0; i < snake.length; i++) {
    if (snake[i].x === c.x && snake[i].y === c.y) return true;
  }
  return false;
}

function finDelJuego() {
  clearInterval(gameLoop);
  document.getElementById("game-over").style.display = "block";
  guardarPuntuacion(score);
}

function reiniciarJuego() {
  iniciarJuego();
}

// ====== PUNTUACIONES / LEADERBOARD ======

async function guardarPuntuacion(score) {
  try {
    const res = await fetch("/api/games/snake/score", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",          //  MUY IMPORTANTE: manda la sesi贸n
      body: JSON.stringify({ score })
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      console.error("Error guardando puntuaci贸n:", data);
      // Si por alguna raz贸n no hay sesi贸n (caduc贸, etc.)
      alert(data.error || "No se pudo guardar tu puntuaci贸n.");
      return;
    }

    console.log("Puntuaci贸n guardada:", data);
    cargarLeaderboard();
  } catch (err) {
    console.error("Error guardando puntuaci贸n", err);
    alert("Hubo un problema de conexi贸n al guardar tu puntuaci贸n.");
  }
}

async function cargarLeaderboard() {
  try {
    const res = await fetch("/api/games/snake/leaderboard", {
      credentials: "include" // no es obligatorio, pero ayuda a que todo sea consistente
    });

    const data = await res.json().catch(() => ({}));

    const tbody = document.getElementById("leaderboard-body");
    tbody.innerHTML = "";

    if (!res.ok) {
      console.error("Error leaderboard:", data);
      tbody.innerHTML = `<tr><td colspan="3">No se pudo cargar la tabla de puntos.</td></tr>`;
      return;
    }

    if (!data.leaderboard || !data.leaderboard.length) {
      tbody.innerHTML = `<tr><td colspan="3">Todav铆a no hay puntuaciones ズ</td></tr>`;
      return;
    }

    data.leaderboard.forEach((item, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>
          ${item.avatarPath ? `<img src="${item.avatarPath}" width="24" height="24">` : ""}
          ${item.displayName || "Usuario"}
        </td>
        <td>${item.bestScore ?? 0}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error("Error cargando leaderboard", err);
    const tbody = document.getElementById("leaderboard-body");
    if (tbody) {
      tbody.innerHTML = `<tr><td colspan="3">No se pudo cargar la tabla de puntos.</td></tr>`;
    }
  }
}

// Iniciar juego y cargar tabla al abrir la p谩gina
iniciarJuego();
cargarLeaderboard();
</script>


</body>
</html>
